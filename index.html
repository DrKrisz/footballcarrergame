<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Football Career Simulator — Dark Mode (Seasons + Injuries + Real Leagues)</title>
<style>
  :root{
    --bg:#0f172a; --card:#1e293b; --ink:#f1f5f9; --muted:#94a3b8; --accent:#22c55e; --accent-2:#3b82f6; --warn:#f59e0b; --danger:#ef4444;
  }
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--ink); font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,sans-serif; display:grid; place-items:center}
  .app{width:min(1200px,96vw); background:var(--card); border-radius:26px; box-shadow:0 12px 30px rgba(0,0,0,.4); padding:20px}
  .row{display:flex; gap:16px; flex-wrap:wrap}
  .col{flex:1 1 320px}
  .card{background:#334155; border-radius:18px; padding:14px}
  h1{font-size:22px; margin:4px 0 10px}
  h2{font-size:16px; margin:0 0 8px}
  .muted{color:var(--muted)}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap}
  button{appearance:none; border:0; border-radius:14px; padding:10px 14px; font-weight:700; cursor:pointer; background:#0f172a; color:#f8fafc; transition:transform .04s ease,opacity .2s}
  button:active{transform:translateY(1px)}
  button[disabled]{opacity:.5; cursor:not-allowed}
  .accent{background:var(--accent); color:#0b1320}
  .alt{background:var(--accent-2)}
  .warn{background:var(--warn)}
  .danger{background:var(--danger)}
  .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
  .stat{background:#1e293b; border-radius:12px; padding:10px; text-align:center; color:var(--ink)}
  .big{font-size:22px; font-weight:800}
  .list{max-height:260px; overflow:auto}
  .pill{display:inline-block; background:#475569; color:var(--ink); border-radius:999px; padding:4px 10px; font-size:12px; margin-right:6px}
  .log{white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; max-height:260px; overflow:auto; background:#0b1020; color:#d1e7ff; border-radius:12px; padding:10px}
  input,select{width:100%; padding:10px 12px; border-radius:12px; border:1px solid #475569; background:#1e293b; color:var(--ink)}
  .hidden{display:none}
  .divider{height:1px; background:#475569; margin:10px 0}
  .offer{display:flex; align-items:center; justify-content:space-between; gap:10px; background:#1e293b; border-radius:12px; padding:10px; margin-bottom:8px}
  .chips{display:flex; gap:6px; flex-wrap:wrap}
</style>
</head>
<body>
  <div class="app" id="app">
    <!-- START SCREEN -->
    <div id="screen-start">
      <h1>Football Career Simulator</h1>
      <p class="muted">Dark, single-file MVP. Weekly turns. Now with <b>Skip Season</b>, <b>injuries</b>, <b>real leagues</b> (top-5, 10 clubs each), <b>prime/decline logic</b>, and two save slots.</p>
      <div class="row">
        <div class="col card">
          <h2>player setup</h2>
          <label>name<input id="name" placeholder="Your name" /></label><br><br>
          <label>age
            <select id="age">
              <option>18</option><option>19</option><option selected>20</option><option>21</option><option>22</option><option>23</option><option>24</option><option>25</option>
              <option>26</option><option>27</option><option>28</option><option>29</option><option>30</option>
            </select>
          </label><br><br>
          <label>position
            <select id="pos">
              <option value="ST">ST striker</option>
              <option value="CAM">CAM playmaker</option>
              <option value="CM">CM box to box</option>
              <option value="CB">CB defender</option>
              <option value="GK">GK keeper</option>
            </select>
          </label><br><br>
          <label>difficulty
            <select id="diff">
              <option value="easy">easy</option>
              <option value="normal" selected>normal</option>
              <option value="hard">hard</option>
            </select>
          </label>
          <div class="divider"></div>
          <div class="toolbar">
            <button class="accent" id="startBtn">Start career</button>
          </div>
        </div>
        <div class="col card">
          <h2>what's included</h2>
          <ul>
            <li>Skip Season simulates to season end fast</li>
            <li>Injuries from 1 week to career-ending</li>
            <li>Prime 20–26; decline accelerates if form is poor</li>
            <li>Top-5 leagues, realistic salary ranges</li>
            <li>Market value from OVR, fame, age, form, position</li>
            <li>Two save slots (A/B)</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="screen-game" class="hidden">
      <div class="row">
        <div class="col">
          <div class="card">
            <h1 id="clubName">Free Agent</h1>
            <div class="chips">
              <span class="pill" id="seasonPill">Season 1</span>
              <span class="pill" id="weekPill">Week 1/40</span>
              <span class="pill" id="agePill">Age 20</span>
              <span class="pill" id="posPill"></span>
              <span class="pill" id="leaguePill">League: None</span>
              <span class="pill" id="salaryPill">Salary 0k/w</span>
              <span class="pill" id="famePill">Fame 0</span>
              <span class="pill" id="valuePill">Value €0.0m</span>
              <span class="pill" id="injuryPill" class="hidden">Healthy</span>
            </div>
            <div class="divider"></div>
            <div class="grid">
              <div class="stat"><div class="big" id="ovr">60</div><div>overall</div></div>
              <div class="stat"><div class="big" id="energy">80</div><div>energy</div></div>
              <div class="stat"><div class="big" id="morale">70</div><div>morale</div></div>
            </div>
            <div class="grid" style="margin-top:10px">
              <div class="stat"><div class="big" id="shoot">55</div><div>shoot</div></div>
              <div class="stat"><div class="big" id="pass">55</div><div>pass</div></div>
              <div class="stat"><div class="big" id="pace">55</div><div>pace</div></div>
              <div class="stat"><div class="big" id="def">55</div><div>def</div></div>
              <div class="stat"><div class="big" id="phys">55</div><div>phys</div></div>
              <div class="stat"><div class="big" id="gk">40</div><div>gk</div></div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <h2>this week</h2>
            <div id="fixture" class="muted">no club, find a contract to play matches</div>
            <div class="toolbar" style="margin-top:8px">
              <button id="btnTrain" class="alt">Train</button>
              <button id="btnRest">Rest</button>
              <button id="btnSocial" class="warn">Social media</button>
              <button id="btnFindClub" class="accent">Request trials</button>
              <button id="btnOpenMarket" class="accent">Open market</button>
              <button id="btnPlay" class="accent" disabled>Play match</button>
              <button id="btnSkipSeason" class="accent">Skip season</button>
            </div>
          </div>
          <div class="card">
            <h2>log</h2>
            <div id="log" class="log"></div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <h2>transfers</h2>
            <div id="offers" class="list"></div>
            <div class="toolbar">
              <button id="btnRefreshOffers" class="alt">Refresh offers</button>
              <button id="btnLeave" class="danger">Leave club</button>
            </div>
          </div>
          <div class="card">
            <h2>career</h2>
            <div id="career" class="list"></div>
            <div class="divider"></div>
            <div class="toolbar">
              <button id="saveABtn" class="alt">Save A</button>
              <button id="loadABtn">Load A</button>
              <button id="saveBBtn" class="alt">Save B</button>
              <button id="loadBBtn">Load B</button>
              <button id="clearBtn" class="danger">Clear saves</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // ====== CONSTANTS ======
  const SEASON_WEEKS = 40; // requested 40-week season

  // Top-5 leagues, 10 clubs each with rough level and salary band multipliers
  const LEAGUES = [
    {name:'Premier League', prestige:1.00, salaryMult:1.6, clubs:[
      {n:'Manchester City',lvl:88},{n:'Arsenal',lvl:86},{n:'Liverpool',lvl:86},{n:'Manchester United',lvl:84},{n:'Chelsea',lvl:83},
      {n:'Tottenham',lvl:84},{n:'Newcastle',lvl:82},{n:'Aston Villa',lvl:83},{n:'Brighton',lvl:81},{n:'West Ham',lvl:80}
    ]},
    {name:'La Liga', prestige:0.95, salaryMult:1.4, clubs:[
      {n:'Real Madrid',lvl:90},{n:'Barcelona',lvl:88},{n:'Atlético Madrid',lvl:86},{n:'Real Sociedad',lvl:83},{n:'Sevilla',lvl:82},
      {n:'Villarreal',lvl:82},{n:'Valencia',lvl:81},{n:'Athletic Club',lvl:82},{n:'Real Betis',lvl:82},{n:'Celta Vigo',lvl:79}
    ]},
    {name:'Serie A', prestige:0.9, salaryMult:1.2, clubs:[
      {n:'Inter',lvl:88},{n:'AC Milan',lvl:86},{n:'Juventus',lvl:86},{n:'Napoli',lvl:85},{n:'Roma',lvl:83},
      {n:'Lazio',lvl:82},{n:'Atalanta',lvl:84},{n:'Fiorentina',lvl:81},{n:'Bologna',lvl:80},{n:'Torino',lvl:79}
    ]},
    {name:'Bundesliga', prestige:0.92, salaryMult:1.25, clubs:[
      {n:'Bayern Munich',lvl:90},{n:'Borussia Dortmund',lvl:86},{n:'RB Leipzig',lvl:85},{n:'Bayer Leverkusen',lvl:86},{n:'VfB Stuttgart',lvl:84},
      {n:'Eintracht Frankfurt',lvl:82},{n:'Wolfsburg',lvl:81},{n:'Freiburg',lvl:81},{n:'Hoffenheim',lvl:80},{n:'Gladbach',lvl:80}
    ]},
    {name:'Ligue 1', prestige:0.85, salaryMult:1.0, clubs:[
      {n:'Paris SG',lvl:90},{n:'Monaco',lvl:84},{n:'Lille',lvl:83},{n:'Marseille',lvl:83},{n:'Lyon',lvl:82},
      {n:'Nice',lvl:82},{n:'Rennes',lvl:82},{n:'Nantes',lvl:78},{n:'Montpellier',lvl:78},{n:'Saint-Étienne',lvl:77}
    ]}
  ];

  // ====== STATE ======
  const s = {
    name:"", pos:"ST", age:20, season:1, week:1,
    skills:{shoot:55, pass:55, pace:55, def:55, phys:55, gk:40},
    energy:80, morale:70, fame:0, ovr:60,
    club:null, league:null, salary:0, fixture:null,
    injury:null, // {name, weeks}
    stats:{apps:0, goals:0, ast:0, cs:0, ratingSum:0},
    offers:[]
  };

  // ====== UTIL ======
  const rnd = (a,b)=>Math.random()*(b-a)+a;
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const round=(v,d=0)=>{const m=Math.pow(10,d);return Math.round(v*m)/m};
  const money = (m)=>`€${round(m,1)}m`;
  const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];

  // ====== DOM ======
  const $ = (id)=>document.getElementById(id);
  const screenStart = $('screen-start');
  const screenGame = $('screen-game');
  const startBtn = $('startBtn');
  const nameIn = $('name');
  const ageIn = $('age');
  const posIn = $('pos');
  const diffIn = $('diff');

  const clubName = $('clubName');
  const seasonPill = $('seasonPill');
  const weekPill = $('weekPill');
  const agePill = $('agePill');
  const posPill = $('posPill');
  const leaguePill = $('leaguePill');
  const salaryPill = $('salaryPill');
  const famePill = $('famePill');
  const valuePill = $('valuePill');
  const injuryPill = $('injuryPill');
  const fixtureEl = $('fixture');
  const logEl = $('log');
  const careerEl = $('career');
  const offersEl = $('offers');

  const ovrEl = $('ovr');
  const eEl = $('energy');
  const mEl = $('morale');
  const shEl = $('shoot');
  const paEl = $('pass');
  const pcEl = $('pace');
  const dfEl = $('def');
  const phEl = $('phys');
  const gkEl = $('gk');

  const btnTrain = $('btnTrain');
  const btnRest = $('btnRest');
  const btnSocial = $('btnSocial');
  const btnFind = $('btnFindClub');
  const btnOpenMarket = $('btnOpenMarket');
  const btnPlay = $('btnPlay');
  const btnSkipSeason = $('btnSkipSeason');

  const btnRefreshOffers = $('btnRefreshOffers');
  const btnLeave = $('btnLeave');

  const saveABtn = $('saveABtn');
  const loadABtn = $('loadABtn');
  const saveBBtn = $('saveBBtn');
  const loadBBtn = $('loadBBtn');
  const clearBtn = $('clearBtn');

  // ====== CORE ======
  function log(t){
    const time = `S${s.season}W${s.week}`;
    logEl.textContent = `${time} • ${t}\n` + logEl.textContent;
  }

  function updateOVR(){
    const posWeights = {
      ST:{shoot:3, pass:2, pace:3, def:1, phys:2, gk:0.5},
      CAM:{shoot:2, pass:3, pace:2, def:1, phys:2, gk:0.5},
      CM:{shoot:2, pass:2, pace:2, def:2, phys:2, gk:0.5},
      CB:{shoot:1, pass:1.5, pace:2, def:3, phys:3, gk:0.5},
      GK:{shoot:0.5, pass:1, pace:1, def:1.5, phys:2, gk:4}
    }[s.pos] || {shoot:2, pass:2, pace:2, def:2, phys:2, gk:1};
    let sum=0, weight=0;
    for(const k in s.skills){ sum += s.skills[k]*posWeights[k]; weight += posWeights[k]; }
    s.ovr = round(sum/weight);
  }

  function marketValue(){
    const posMult = {ST:1.15, CAM:1.12, CM:1.0, CB:0.9, GK:0.85}[s.pos] || 1.0;
    let ageF = 1.0; // prime 20–26
    if(s.age <= 19) ageF = 1.25; else if (s.age <= 23) ageF = 1.2; else if (s.age <= 26) ageF = 1.15; else if (s.age <= 29) ageF = 1.0; else if (s.age <= 32) ageF = 0.9; else ageF = 0.7;
    const form = s.stats.apps ? s.stats.ratingSum/s.stats.apps : 6.0;
    const ovrF = Math.pow(s.ovr/60, 2);
    const fameF = 1 + s.fame/400;
    const leaguePrestige = s.league ? s.league.prestige : 0.8;
    const base = 0.8 + ovrF*9 + Math.max(0,form-6)*2; // in millions
    return round(base * posMult * ageF * fameF * leaguePrestige, 1);
  }

  function draw(){
    updateOVR();
    clubName.textContent = s.club ? s.club.name : 'Free Agent';
    seasonPill.textContent = `Season ${s.season}`;
    weekPill.textContent = `Week ${s.week}/${SEASON_WEEKS}`;
    agePill.textContent = `Age ${s.age}`;
    posPill.textContent = s.pos;
    leaguePill.textContent = `League: ${s.league? s.league.name : 'None'}`;
    salaryPill.textContent = `Salary ${s.salary}k/w`; 
    famePill.textContent = `Fame ${s.fame}`;
    valuePill.textContent = `Value ${money(marketValue())}`;

    injuryPill.textContent = s.injury ? `Injured: ${s.injury.name} (${s.injury.weeks}w)` : 'Healthy';
    injuryPill.style.background = s.injury ? '#b91c1c' : '#16a34a';

    ovrEl.textContent = s.ovr;
    eEl.textContent = s.energy;
    mEl.textContent = s.morale;
    shEl.textContent = s.skills.shoot;
    paEl.textContent = s.skills.pass;
    pcEl.textContent = s.skills.pace;
    dfEl.textContent = s.skills.def;
    phEl.textContent = s.skills.phys;
    gkEl.textContent = s.skills.gk;

    if(s.fixture){
      fixtureEl.textContent = `${s.fixture.home} vs ${s.fixture.away} • opp ${s.fixture.strength}`;
    } else {
      fixtureEl.textContent = s.club ? 'next match to be scheduled' : 'no club, request trials or open market';
    }

    btnPlay.disabled = !s.fixture || !!s.injury; // can't play injured
    renderOffers();
    renderCareer();
  }

  function nextWeek(){
    s.week += 1; if(s.week > SEASON_WEEKS){ s.week = 1; s.season += 1; s.age += 1; log(`new season. age now ${s.age}`); endSeasonAdjustments(); }
    // injury countdown + decay while injured
    if(s.injury){
      s.injury.weeks -= 1;
      // injured decay 2x faster than idle: small all-skill dip
      for(const k in s.skills){ s.skills[k] = clamp(s.skills[k] - 1, 30, 99); }
      if(s.injury.weeks <= 0){ log(`injury healed: ${s.injury.name}`); s.injury = null; }
    }
  }

  // after each season apply form-based aging effects
  function endSeasonAdjustments(){
    const avg = s.stats.apps ? s.stats.ratingSum/s.stats.apps : 6.0;
    if(s.age > 26){
      const decline = avg < 6.8 ? 2 : 0; // poor form speeds decline
      const baseDecline = s.age >= 30 ? 2 : 1;
      const totalDecline = baseDecline + decline;
      for(const k in s.skills){ s.skills[k] = clamp(s.skills[k] - totalDecline, 30, 99); }
      log(`aging decline applied: -${totalDecline} to core skills`);
    }
    // small morale reset and energy refill
    s.energy = 85; s.morale = clamp(s.morale + 2, 0, 100);
    // reset season stats tracking but keep career sums
    s.stats.apps = 0; s.stats.goals = 0; s.stats.ast = 0; s.stats.cs = 0; s.stats.ratingSum = 0;
  }

  function randomInjury(){
    const table = [
      {name:'Bruised foot', min:1, max:2, prob:0.35},
      {name:'Muscle strain', min:2, max:4, prob:0.27},
      {name:'Sprained ankle', min:3, max:6, prob:0.18},
      {name:'Ligament tear', min:8, max:16, prob:0.08},
      {name:'Fracture', min:10, max:20, prob:0.06},
      {name:'Career-ending', min:999, max:999, prob:0.01},
      {name:'Concussion', min:1, max:3, prob:0.05}
    ];
    const r = Math.random();
    let acc = 0;
    for(const it of table){ acc += it.prob; if(r <= acc){ return it; } }
    return null;
  }

  function maybeInjure(context){
    if(s.injury) return; // already injured
    const base = context==='match' ? 0.08 : 0.03; // higher in matches
    const physProtect = (s.skills.phys-50)/200; // better phys reduces chance
    const chance = clamp(base - physProtect, 0.01, 0.12);
    if(Math.random() < chance){
      const inj = randomInjury();
      if(!inj) return;
      if(inj.name==='Career-ending'){ s.injury = {name:inj.name,weeks:999}; log(`career-ending injury! You should retire.`); }
      else { const w = Math.round(rnd(inj.min, inj.max)); s.injury = {name:inj.name,weeks:w}; log(`injured: ${inj.name} (${w} weeks)`); }
    }
  }

  function clubFromLeague(lg, idx){
    const c = lg.clubs[idx];
    return {name:c.n, level:c.lvl, league:lg};
  }

  // schedule realistic matches against random clubs across league
  function scheduleMatch(){
    if(!s.club){ s.fixture = null; return; }
    const lg = s.league || pick(LEAGUES);
    const oppIdx = Math.floor(Math.random()*lg.clubs.length);
    const opp = lg.clubs[oppIdx];
    s.fixture = {home:s.club.name, away:opp.n, strength:opp.lvl};
    log(`match scheduled: ${s.fixture.home} vs ${s.fixture.away} (opp ${opp.lvl})`);
  }

  // ====== ACTIONS ======
  function train(){
    if(s.injury){ log('cannot train while injured'); nextWeek(); draw(); return; }
    const gain = Math.round(rnd(1,3));
    const target = s.pos === 'GK' ? 'gk' : ['shoot','pass','pace','def','phys'][Math.floor(Math.random()*5)];
    s.skills[target] = clamp(s.skills[target] + gain, 30, 99);
    s.energy = clamp(s.energy - Math.round(rnd(5,10)), 0, 100);
    s.morale = clamp(s.morale + Math.round(rnd(0,2)), 0, 100);
    maybeInjure('train');
    log(`trained ${target} +${gain}`);
    nextWeek();
    if(s.club && !s.fixture) scheduleMatch();
    draw();
  }

  function rest(){
    const en = Math.round(rnd(12,20));
    s.energy = clamp(s.energy + en, 0, 100);
    s.morale = clamp(s.morale + Math.round(rnd(1,4)), 0, 100);
    log(`rest day +${en} energy`);
    nextWeek();
    if(s.club && !s.fixture) scheduleMatch();
    draw();
  }

  function social(){
    const fameGain = Math.round(rnd(3,9));
    s.fame = clamp(s.fame + fameGain, 0, 999);
    s.morale = clamp(s.morale + Math.round(rnd(1,4)), 0, 100);
    s.energy = clamp(s.energy - Math.round(rnd(2,6)), 0, 100);
    log(`social media +${fameGain} fame`);
    nextWeek();
    if(s.club && !s.fixture) scheduleMatch();
    draw();
  }

  // ====== TRANSFERS / OFFERS ======
  function salaryFor(level, lg){
    // approximate thousands per week by level and league multiplier
    const base = clamp((level-55)*1.5 + rnd(3,10), 2, 300); // k/w
    return Math.round(base * (lg?.salaryMult || 1));
  }

  function generateOffers(n=4){
    const out=[];
    for(let i=0;i<n;i++){
      const lg = pick(LEAGUES);
      const club = pick(lg.clubs);
      // quality scales with player ovr, fame, league prestige
      const base = s.ovr + s.fame*0.35 + lg.prestige*10;
      const level = clamp(Math.round(base/1.7 + rnd(-8,8)), 55, 92);
      const salary = salaryFor(level, lg);
      out.push({name:club.n, level, salary, league:lg});
    }
    out.sort((a,b)=>b.level-a.level);
    return out;
  }

  function renderOffers(){
    offersEl.innerHTML = '';
    s.offers.forEach((o,idx)=>{
      const el = document.createElement('div');
      el.className='offer';
      el.innerHTML = `<div>
        <div><b>${o.name}</b> • level ${o.level}</div>
        <div class="muted">${o.league.name} • salary ${o.salary}k/w</div>
      </div>
      <div class="toolbar"><button class="accent" data-idx="${idx}">Sign</button></div>`;
      offersEl.appendChild(el);
    });
    Array.from(offersEl.querySelectorAll('button[data-idx]')).forEach(btn=>{
      btn.onclick = ()=>{
        const i = parseInt(btn.getAttribute('data-idx'));
        const offer = s.offers[i];
        s.club = {name: offer.name, level: offer.level};
        s.league = offer.league;
        s.salary = offer.salary;
        s.offers = [];
        log(`signed for ${s.club.name} (${s.league.name}) • ${s.salary}k/w`);
        scheduleMatch();
        draw();
      };
    });
  }

  function refreshOffers(){ s.offers = generateOffers(5); log('market refreshed'); renderOffers(); }
  function leaveClub(){ if(!s.club){ log('already free agent'); return; } log(`left ${s.club.name}`); s.club=null; s.league=null; s.salary=0; s.fixture=null; draw(); }
  function trials(){ s.offers = generateOffers(4); log('trial offers arrived'); renderOffers(); nextWeek(); draw(); }
  function openMarket(){ refreshOffers(); nextWeek(); draw(); }

  // ====== MATCH ENGINE ======
  function playMatch(){
    if(!s.fixture || s.injury) return;
    const opp = s.fixture.strength;
    const fatigue = clamp(1 - (s.energy/140), 0.6, 1.0);
    const moraleBoost = 1 + (s.morale - 50)/200;
    const posBias = s.pos==='ST'?1.08: s.pos==='CAM'?1.05: s.pos==='CM'?1.0: s.pos==='CB'?0.95: s.pos==='GK'?0.9:1.0;
    const perfBase = s.ovr * moraleBoost * posBias * (1 - (1-fatigue)*0.5);
    const variance = rnd(-8, 8);
    const performance = clamp(perfBase + variance, 30, 99);

    const teamStrength = (s.club? s.club.level : 60) + (performance - 60)*0.2;
    const oppStrength = opp;
    const goalChance = clamp((teamStrength - oppStrength + 10)/40, 0.08, 0.65);
    const concedeChance = clamp((oppStrength - teamStrength + 10)/40, 0.08, 0.65);
    const goalsFor = Math.max(0, Math.round(rnd(0,3) + (Math.random()<goalChance?1:0)));
    const goalsAgainst = Math.max(0, Math.round(rnd(0,3) + (Math.random()<concedeChance?1:0)));

    let goals=0, ast=0, cs=0;
    if(['ST','CAM','CM'].includes(s.pos)){
      for(let i=0;i<goalsFor;i++) if(Math.random()< (0.35 + (performance-60)/150)) goals++;
      for(let i=0;i<goalsFor-goals;i++) if(Math.random()<0.4) ast++;
    } else if(['CB','GK'].includes(s.pos)){
      cs = goalsAgainst===0 ? 1 : 0;
    }

    const rating = clamp(Math.round(6 + (performance-60)/10 + goals*0.6 + ast*0.4 + cs*0.5 + rnd(-0.5,0.5)), 4, 10);

    s.stats.apps++; s.stats.goals+=goals; s.stats.ast+=ast; s.stats.cs+=cs; s.stats.ratingSum+=rating;
    s.energy = clamp(s.energy - Math.round(rnd(12,20)), 0, 100);
    s.morale = clamp(s.morale + (rating>=7?2:-1), 0, 100);
    s.fame = clamp(s.fame + (rating>=8?3:2) + goals, 0, 999);

    log(`match ${s.fixture.home} ${goalsFor}-${goalsAgainst} ${s.fixture.away} • rating ${rating} • g ${goals} a ${ast}${cs?` • clean sheet`:''}`);

    const xp = Math.round(performance/10 + rating + goals*2 + ast*1.5 + cs*1.5);
    const targets = s.pos==='GK' ? ['gk','pass','phys'] : ['shoot','pass','pace','def','phys'];
    for(let i=0;i<2;i++){
      const t = targets[Math.floor(Math.random()*targets.length)];
      s.skills[t] = clamp(s.skills[t] + Math.max(1, Math.round(xp/20)), 30, 99);
    }

    if(s.salary) log(`salary earned ${s.salary}k`);

    // injury roll after match
    maybeInjure('match');

    s.fixture = null;
    nextWeek();
    scheduleMatch();
    draw();
  }

  // ====== SKIP SEASON ======
  function skipSeason(){
    let safety = 200; // prevent infinite
    while(s.week <= SEASON_WEEKS && safety-- > 0){
      // auto schedule if missing
      if(s.club && !s.fixture) scheduleMatch();
      if(s.injury){ rest(); continue; }
      if(s.fixture) { playMatch(); }
      else { // no fixture yet
        if(!s.club){ trials(); } else { rest(); }
      }
      if(s.week === 1) break; // new season started
    }
    log('season skipped');
    draw();
  }

  // ====== RENDER SMALL PANELS ======
  function renderCareer(){
    const avg = s.stats.apps ? (s.stats.ratingSum/s.stats.apps).toFixed(2) : '0.00';
    careerEl.innerHTML = `
      <div>apps: <b>${s.stats.apps}</b> • goals: <b>${s.stats.goals}</b> • assists: <b>${s.stats.ast}</b> • clean sheets: <b>${s.stats.cs}</b></div>
      <div>avg rating: <b>${avg}</b></div>
      <div>club: <b>${s.club? s.club.name : 'free agent'}</b> • league: <b>${s.league? s.league.name : '—'}</b> • salary: <b>${s.salary}k/w</b></div>
      <div>market value: <b>${money(marketValue())}</b></div>
    `;
  }

  // ====== SAVE/LOAD (2 slots) ======
  function save(slot){ localStorage.setItem('fcareer_'+slot, JSON.stringify(s)); log('saved to '+slot); }
  function load(slot){ const raw = localStorage.getItem('fcareer_'+slot); if(!raw){ log('no save in '+slot); return; } Object.assign(s, JSON.parse(raw)); log('loaded '+slot); draw(); }
  function clear(){ ['A','B'].forEach(k=>localStorage.removeItem('fcareer_'+k)); log('saves cleared'); }

  // ====== INIT / EVENTS ======
  startBtn.onclick = ()=>{
    s.name = nameIn.value.trim() || 'Rookie';
    s.pos = posIn.value;
    s.age = parseInt(ageIn.value,10) || 20;
    const diff = diffIn.value;
    if(diff==='easy'){ s.skills = {shoot:60, pass:60, pace:60, def:58, phys:60, gk:s.pos==='GK'?60:40}; s.energy=85; s.morale=75; s.fame=10; }
    if(diff==='hard'){ s.skills = {shoot:50, pass:50, pace:50, def:50, phys:50, gk:s.pos==='GK'?50:40}; s.energy=70; s.morale=60; }
    updateOVR();
    screenStart.classList.add('hidden');
    screenGame.classList.remove('hidden');
    log(`career started for ${s.name} • ${s.pos} • age ${s.age}`);
    draw();
  };

  btnTrain.onclick = ()=>{ train(); };
  btnRest.onclick = ()=>{ rest(); };
  btnSocial.onclick = ()=>{ social(); };
  btnFind.onclick = ()=>{ trials(); };
  btnOpenMarket.onclick = ()=>{ openMarket(); };
  btnPlay.onclick = ()=>{ playMatch(); };
  btnSkipSeason.onclick = ()=>{ skipSeason(); };

  btnRefreshOffers.onclick = ()=>{ refreshOffers(); };
  btnLeave.onclick = ()=>{ leaveClub(); };

  saveABtn.onclick = ()=>{ save('A'); };
  loadABtn.onclick = ()=>{ load('A'); };
  saveBBtn.onclick = ()=>{ save('B'); };
  loadBBtn.onclick = ()=>{ load('B'); };
  clearBtn.onclick = ()=>{ clear(); };
})();
</script>
</body>
</html>
